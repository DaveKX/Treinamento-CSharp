@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations

<MudDialogProvider />

@page "/cadastro"
@rendermode InteractiveServer
@inject ILocalStorageService localStorage
@inject IDialogService DialogService


<PageTitle>Cadastro</PageTitle>

<MudGrid>
    <MudItem xs="12" sm="7">
        <MudPaper Class="pa-4 mt-4">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" DropShadow="false" OnClick="@(() => OpenDialogPessoa("Cadastrar"))">Adicionar</MudButton>
        </MudPaper>
    </MudItem>
</MudGrid>

@if (pessoas == null)
{
    <MudProgressCircular Color="Color.Success" Indeterminate="true" />
}
else
{
    <MudDataGrid Items="@pessoas" ReadOnly="false" SortMode="@SortMode.Single" EditMode="DataGridEditMode.Form">
        <Columns>
            <PropertyColumn Property="x => x.Id" Title="ID" Editable="false" />
            <PropertyColumn Property="x => x.Nome" />
            <PropertyColumn Property="x => x.Telefone" />
            <PropertyColumn Property="x => x.Endereco" />
            <TemplateColumn CellClass="d-flex justify-center">
                <CellTemplate>
                    <MudStack Row>
                        <MudButton Size="@Size.Small" Variant="@Variant.Filled" Color="@Color.Primary" OnClick="@(() => OpenDialogPessoa("Editar", context.Item))">Editar</MudButton>
                        <MudButton Size="@Size.Small" Variant="@Variant.Filled" Color="@Color.Primary" OnClick="@(() => OpenDialogPessoa("Deletar", context.Item))">Deletar</MudButton>
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
}


@code {
    bool success;
    List<Pessoa> pessoas = new();
    Pessoa pessoa = new();
    const string stringKey = "pessoas";
    bool isInitialized;

    private async Task OpenDialogPessoa(string acao, Pessoa pessoa = null)
    {
        var options = new DialogOptions()
            {
                CloseOnEscapeKey = true,
            };

        pessoa ??= new Pessoa();
        var pessoaCopia = new Pessoa
            {
                Id = pessoa.Id,
                Nome = pessoa.Nome,
                Telefone = pessoa.Telefone,
                Endereco = pessoa.Endereco
            };

        var dialogParameters = new DialogParameters<DialogPessoa>
    {
        { x => x.pessoa, pessoaCopia },
        { x => x.acao, acao },
        { x => x.addPessoa, EventCallback.Factory.Create<Pessoa>(this, AddPessoa) },
        { x => x.editarPessoa, EventCallback.Factory.Create<Pessoa>(this, EditarPessoa) },
        { x => x.deletarPessoa, EventCallback.Factory.Create<Pessoa>(this, DeletarPessoa) }
    };

        var dialog = await DialogService.ShowAsync<DialogPessoa>("Pessoa", dialogParameters, options);
        await dialog.Result;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadPessoasFromLocalStorage();
            isInitialized = true;
        }
    }

    private async Task LoadPessoasFromLocalStorage()
    {
        await Task.Delay(100);
        var storedPessoas = await localStorage.GetItemAsync<List<Pessoa>>(stringKey);
        if (storedPessoas != null)
        {
            pessoas = storedPessoas;
        }
        else
        {
            pessoas = new List<Pessoa>();
        }
        StateHasChanged();
    }

    private async Task AtualizaLocalStorage()
    {
        await localStorage.SetItemAsync(stringKey, pessoas);
    }

    private async Task AddPessoa(Pessoa pessoa)
    {
        if (pessoas.Count != 0)
        {
            var lastID = pessoas.Last().Id;
            pessoa.Id = lastID + 1;
        }
        else
        {
            pessoa.Id = 0;
        }
        pessoas.Add(pessoa);
        await AtualizaLocalStorage();
        pessoa = new();
    }

    private async Task DeletarPessoa(Pessoa p)
    {
        var pessoaIndex = BuscarPessoaIndexById(p.Id);
        if (pessoaIndex == -1)
            return;

        pessoas.RemoveAt(pessoaIndex);
        await AtualizaLocalStorage();
    }

    private async Task EditarPessoa(Pessoa p)
    {
        var pessoaIndex = BuscarPessoaIndexById(p.Id);
        if (pessoaIndex == -1)
            return;

        pessoas[pessoaIndex] = p;
        await AtualizaLocalStorage();
    }

    private int BuscarPessoaIndexById(int id)
    {
        return pessoas.FindIndex(p => p.Id == id);
    }

}
